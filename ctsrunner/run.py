#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Usage:
    run.py run cts --plan <plan_name>
    run.py run cts (--package|-p) <package_name>
    run.py run cts (--class|-c) <class_name>
"""

import re
import subprocess

CTSCONSOLE = 'android-cts/tools/cts-tradefed'


def cts_console(*args):
    print("cts_console running cts now...")
    proc = subprocess.Popen(
        args,
        shell=False,
        stdin=subprocess.PIPE,
        stderr=subprocess.PIPE,
        stdout=subprocess.PIPE)
    result = (0, 0, 0)
    while proc.poll() is None:
        line = proc.stdout.readline()
        if line:
            print line,
            m = re.search(r'XML\s+test\s+result\s+file\s+generated\s+at\s+[\d\._]+\s+Passed\s+(\d+),\s+Failed\s+(\d+),\s+Not Executed\s+(\d)+', line)
            if m:
                result = (int(m.group(1)), int(m.group(2)), int(m.group(3)))
    return result

if __name__ == "__main__":
    result = cts_console(CTSCONSOLE, 'run', 'cts', '--plan', 'CTS')
    if result[1] > 0:
        print('Re-run failed cases...')
        cts_console(CTSCONSOLE, 'add', 'derivedplan', '--plan', 'failed_plan', '-s', '0', '-r', 'fail')
        cts_console(CTSCONSOLE, 'run', 'cts', '--plan', 'failed_plan')
